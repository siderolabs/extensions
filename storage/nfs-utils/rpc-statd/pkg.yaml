name: rpc-statd
variant: scratch
shell: /bin/bash
dependencies:
  - stage: base
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/fhs:{{ .BUILD_ARG_PKGS }}"
    from: /
    to: /rootfs/usr/local/lib/containers/rpc-statd
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/musl:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/rpc-statd/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libcap:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/rpc-statd/usr/lib
  - stage: libtirpc
    from: /rootfs/usr/local/lib
    to: /rootfs/usr/local/lib/containers/rpc-statd/usr/lib
  - stage: libtirpc
    from: /rootfs
  - stage: rpcsvc-proto
    from: /rootfs
  - stage: libxml2
    from: /rootfs
  - stage: libevent
    from: /rootfs
  - stage: sqlite
    from: /rootfs
steps:
  - sources:
      - url: https://www.kernel.org/pub/linux/utils/nfs-utils/{{ .NFS_UTILS_VERSION }}/nfs-utils-{{ .NFS_UTILS_VERSION }}.tar.xz
        destination: nfs-utils.tar.xz
        sha256: {{ .NFS_UTILS_SHA256 }}
        sha512: {{ .NFS_UTILS_SHA512 }}
    env:
      SOURCE_DATE_EPOCH: {{ .BUILD_ARG_SOURCE_DATE_EPOCH }}
    prepare:
      - |
        tar -xJf nfs-utils.tar.xz --strip-components=1
      - |
        # Apply patches
        patch -p1 < /pkg/rpc-statd-create-directories.patch
        patch -p1 < /pkg/rpc-statd-separate-debug-from-stderr.patch
        patch -p1 < /pkg/sm-notify-fix-unrecognized-service.patch
    build:
      - |
        export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:/usr/lib/pkgconfig
        export CFLAGS="${CFLAGS} -I/usr/local/include"
        export LDFLAGS="${LDFLAGS} -L/usr/local/lib"

        ./configure \
          --prefix=/usr/local/lib/containers/rpc-statd \
          --sbindir=/usr/local/lib/containers/rpc-statd/sbin \
          --disable-nfsv4 \
          --disable-nfsv41 \
          --disable-nfsdcld \
          --disable-gss \
          --disable-svcgss \
          --disable-kprefix \
          --disable-nfsdctl \
          --without-tcp-wrappers \
          --with-rpcgen=/usr/local/bin/rpcgen \
          --with-statedir=/var/lib/nfs \
          --with-statdpath=/var/lib/nfs/statd
      - |
        make -C support/nsm -j $(nproc)
        make -C support/misc -j $(nproc)
        make -C support/nfs -j $(nproc)
        make -C utils/statd -j $(nproc)
    install:
      - |
        # Install only rpc.statd and sm-notify from the built directories
        make DESTDIR=/rootfs install -C utils/statd

        # cleanup
        rm -rf /rootfs/usr/local/lib/containers/rpc-statd/share
      - |
        mkdir -p /rootfs/usr/local/lib/containers/rpc-statd/etc

        cp /pkg/files/* /rootfs/usr/local/lib/containers/rpc-statd/etc/
      - |
        mkdir -p /rootfs/usr/local/etc/containers

        cp /pkg/rpc-statd.yaml /rootfs/usr/local/etc/containers/rpc-statd.yaml
    sbom:
      outputPath: /rootfs/usr/local/share/spdx/nfs-utils.spdx.json
      version: {{ .NFS_UTILS_VERSION }}
      cpes:
        - cpe:2.3:a:nfs:nfs-utils:{{ .NFS_UTILS_VERSION }}:*:*:*:*:*:*:*
      licenses:
        - GPL-2.0
finalize:
  - from: /rootfs
    to: /rootfs
