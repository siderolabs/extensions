name: multipath-tools
variant: scratch
shell: /bin/bash
dependencies:
  - stage: base
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/fhs:{{ .BUILD_ARG_PKGS }}"
    from: /
    to: /rootfs/usr/local/lib/containers/multipath-tools
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/musl:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/systemd-udevd:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libjson-c:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/lvm2:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/liburcu:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libaio:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/util-linux:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libcap:{{ .BUILD_ARG_PKGS }}"
    from: /usr/lib
    to: /rootfs/usr/local/lib/containers/multipath-tools/usr/lib
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/systemd-udevd:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libjson-c:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/lvm2:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/liburcu:{{ .BUILD_ARG_PKGS }}"
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libaio:{{ .BUILD_ARG_PKGS }}"
steps:
  - sources:
      - url: https://github.com/opensvc/multipath-tools/archive/refs/tags/{{ .MULTIPATH_TOOLS_VERSION }}.tar.gz
        destination: multipath-tools.tar.gz
        sha256: {{ .MULTIPATH_TOOLS_SHA256 }}
        sha512: {{ .MULTIPATH_TOOLS_SHA512 }}
    env:
      PKG_CONFIG_PATH: /usr/lib/pkgconfig
    prepare:
      - |
        tar -xzf multipath-tools.tar.gz --strip-components=1
    build:
      - |
        make -j $(nproc) prefix="/usr/local/lib/containers/multipath-tools" \
          sysconfdir="/etc" \
          configdir="/etc/multipath/conf.d" \
          plugindir="/usr/lib/multipath" \
          mandir="/usr/share/man" \
          infodir="/usr/share/info" \
          statedir="/etc/multipath" \
          etc_prefix="" \
          LIB=lib \
          SYSTEMD=""
    install:
      - |
        mkdir -p /rootfs/usr/local/lib/containers/multipath-tools/usr/local/lib/

        cp /usr/lib/libgcc_s.so.1 /rootfs/usr/local/lib/containers/multipath-tools/usr/local/lib/

        make prefix="/usr/local/lib/containers/multipath-tools" DESTDIR=/rootfs LIB=lib install
      - |
        mkdir -p /rootfs/usr/local/etc/containers

        cp /pkg/multipathd.yaml /rootfs/usr/local/etc/containers/
      # Remove kernel module loading config
      - |
        rm -rf /rootfs/usr/local/lib/containers/multipath-tools/modules-load.d
      # Remove unnecessary docs and includes
      - |
        rm -rf /rootfs/usr/local/lib/containers/multipath-tools/share
        rm -rf /rootfs/usr/local/lib/containers/multipath-tools/include
      # This file tries to create a tmpfs mount at `/var/run/multipath`.
      - |
        rm -rf /rootfs/usr/lib/tmpfiles.d/
      # Removed but might be needed by other users of multipath-tools
      - |
        rm /rootfs/usr/lib/udev/kpartx_id
    test:
      - |
        mkdir -p /extensions-validator-rootfs
        cp -r /rootfs/ /extensions-validator-rootfs/rootfs
        cp /pkg/manifest.yaml /extensions-validator-rootfs/manifest.yaml
        /extensions-validator validate --rootfs=/extensions-validator-rootfs --pkg-name="${PKG_NAME}"
finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
