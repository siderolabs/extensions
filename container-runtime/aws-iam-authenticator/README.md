# AWS IAM Authenticator Extension

This extension provides the [aws-iam-authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator) for Talos Linux. The AWS IAM Authenticator allows you to use AWS IAM credentials to authenticate to your Kubernetes cluster, eliminating the need to manage static kubeconfig files.

## Overview

The extension includes:
- The `aws-iam-authenticator` binary for server-side authentication
- A custom init wrapper that generates certificates and kubeconfig files on node startup
- Support for configurable init parameters via environment variables

When installed, the extension runs during node initialization to generate the necessary certificates, private keys, and webhook kubeconfig files required for the kube-apiserver to authenticate users via AWS IAM.

## Installation

See [Installing Extensions](https://github.com/siderolabs/extensions#installing-extensions).

## Configuration

### 1. Extension Service Configuration

Configure the extension via `ExtensionServiceConfig` document. Below is an example with all available environment variables:

```yaml
# aws-iam-authenticator-config.yaml
---
apiVersion: v1alpha1
kind: ExtensionServiceConfig
name: aws-iam-authenticator
environment:
  # Required: Cluster identifier (must match the cluster ID used by clients)
  - CLUSTER_ID=my-cluster
  # Optional: Hostname for self-signed certificates (default: localhost)
  - HOSTNAME=kubernetes.example.com
  # Optional: IP address to bind the server to (default: 127.0.0.1)
  - ADDRESS=127.0.0.1
  # Optional: Path to configuration file
  - CONFIG_FILE=/usr/local/lib/aws-iam-authenticator/config.yaml
  # Optional: Log format (text or json)
  - LOG_FORMAT=json
```

Then apply the patch to your node's MachineConfigs:
```bash
talosctl patch mc -p @aws-iam-authenticator-config.yaml
```

You can verify that it is in place with the following command:
```bash
talosctl get extensionserviceconfigs

NODE     NAMESPACE   TYPE                     ID                       VERSION
mynode   runtime     ExtensionServiceConfig   aws-iam-authenticator    1
```

**Environment Variables:**

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `CLUSTER_ID` | Yes | - | Unique cluster identifier. Must match the `-i` flag used by clients to prevent replay attacks across clusters. |
| `HOSTNAME` | No | `localhost` | Hostname used when generating self-signed certificates. Set this to your API server's hostname. |
| `ADDRESS` | No | `127.0.0.1` | IP address the authenticator server will bind to. Use `127.0.0.1` for local-only or `0.0.0.0` to listen on all interfaces. |
| `CONFIG_FILE` | No | - | Path to a configuration file for advanced settings (role mappings, backend mode, etc.). |
| `LOG_FORMAT` | No | `text` | Log output format. Options: `text` or `json`. |

### 2. Kube-APIServer Configuration

After installing the extension, you must configure the kube-apiserver to use the webhook authentication method. Add the following to your Talos cluster configuration:

```yaml
cluster:
  apiServer:
    extraArgs:
      authentication-token-webhook-config-file: /usr/local/lib/aws-iam-authenticator/kubeconfig.yaml
    extraVolumes:
      - hostPath: /usr/local/lib/aws-iam-authenticator
        mountPath: /usr/local/lib/aws-iam-authenticator
        readOnly: true
```

**What this does:**
- `authentication-token-webhook-config-file`: Tells the kube-apiserver to validate bearer tokens using the webhook configuration generated by aws-iam-authenticator
- The volume mount gives the API server access to the generated kubeconfig and certificates

### 3. AWS IAM Authenticator Server DaemonSet

After the init process generates the certificates and kubeconfig, you need to deploy the aws-iam-authenticator server as a DaemonSet on control plane nodes.

**Important:** Make sure to configure the DaemonSet with the following requirements:
- Point `--config`, `--state-dir`, and `--generate-kubeconfig` to `/usr/local/lib/aws-iam-authenticator`
- Include the `--kubeconfig-pregenerated=true` flag since the extension has already generated the kubeconfig
- Mount `/usr/local/lib/aws-iam-authenticator` from the host

See [example-daemonset.yaml](example-daemonset.yaml) for a complete working example.

### 4. Client Configuration and IAM Role Mapping

For client-side configuration and IAM role/user mapping to Kubernetes RBAC groups, please refer to the official documentation:

- [Client Setup - Installing aws-iam-authenticator](https://github.com/kubernetes-sigs/aws-iam-authenticator#4-set-up-kubectl-to-use-authentication-tokens-provided-by-aws-iam-authenticator-for-kubernetes)
- [IAM Role Mapping Configuration](https://github.com/kubernetes-sigs/aws-iam-authenticator#full-configuration-format)

## How It Works

1. **Initialization**: When a Talos node boots, the extension service runs the init wrapper which executes `aws-iam-authenticator init`
2. **Certificate Generation**: The init command generates:
   - Self-signed certificates for the webhook server
   - A webhook kubeconfig file at `/usr/local/lib/aws-iam-authenticator/kubeconfig.yaml`
3. **API Server Integration**: The kube-apiserver uses the generated kubeconfig to validate authentication tokens via webhook
4. **Authentication Flow**:
   - Client runs `aws-iam-authenticator token -i <cluster-id>` to generate a token
   - Client sends the token to the API server in the Authorization header
   - API server forwards the token to the webhook endpoint
   - The authenticator validates the AWS signature and returns the user identity and groups
   - API server applies RBAC based on the returned groups

## Service Management

The extension service appears in the service list with the `ext-` prefix. Since the init process runs once and exits, the service will show as "Finished":

```bash
$ talosctl services
NODE         SERVICE                        STATE      HEALTH   LAST CHANGE
172.20.0.5   ext-aws-iam-authenticator      Finished   ?        1m38s ago
```

View detailed service information:

```bash
$ talosctl service ext-aws-iam-authenticator
```

View service logs:

```bash
$ talosctl logs ext-aws-iam-authenticator
```

## Troubleshooting

### Check Generated Files

Verify that the init process generated the necessary files:

```bash
$ talosctl ls /usr/local/lib/aws-iam-authenticator/
.
..
cert.pem
key.pem
kubeconfig.yaml
```

### Verify Cluster ID

Ensure the `CLUSTER_ID` in your extension configuration matches the `-i` parameter used by clients:

```bash
$ talosctl logs ext-aws-iam-authenticator | grep "executing"
executing: /usr/local/bin/aws-iam-authenticator [init -i=my-cluster]
```

### Common Issues

- **Authentication fails**: Verify cluster IDs match between server and client
- **Permission denied**: Check that the API server can read `/usr/local/lib/aws-iam-authenticator/kubeconfig.yaml`
- **Certificate errors**: Ensure `HOSTNAME` matches your API server's hostname if using TLS

## References

- [aws-iam-authenticator GitHub Repository](https://github.com/kubernetes-sigs/aws-iam-authenticator)
- [EKS Anywhere - IAM Authentication](https://anywhere.eks.amazonaws.com/docs/clustermgmt/security/cluster-iam-auth/)
- [AWS Best Practices - Identity and Access Management](https://docs.aws.amazon.com/eks/latest/best-practices/identity-and-access-management.html)
