name: libyang
variant: scratch
shell: /bin/bash
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://github.com/CESNET/libyang/archive/refs/tags/v{{ .LIBYANG_VERSION }}.tar.gz
        destination: libyang.tar.gz
        sha256: {{ .LIBYANG_SHA256 }}
        sha512: {{ .LIBYANG_SHA512 }}
    prepare:
      - |
          tar xf libyang.tar.gz --strip-components=1
          cmake . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_INSTALL_LIBDIR=lib \
            -DCMAKE_INSTALL_INCLUDEDIR=include \
            -DBUILD_SHARED_LIBS=True
    build:
      - |
          cmake --build build
    install:
      - |
          DESTDIR=/rootfs cmake --install build
          rm -rf /rootfs/usr/share/man
    test:
      - |
          fhs-validator /rootfs
    sbom:
      outputPath: /rootfs/usr/local/share/spdx/libyang.spdx.json
      version: {{ .LIBYANG_VERSION }}
      licenses:
        - BSD-3-Clause
finalize:
  - from: /rootfs
    to: /
