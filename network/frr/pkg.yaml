name: frr
variant: scratch
shell: /bin/bash
dependencies:
  - stage: base
  - image: "{{ .BUILD_ARG_PKGS_PREFIX }}/libjson-c:{{ .BUILD_ARG_PKGS }}"

  - stage: libyang
  - stage: libbsd
  - stage: libreadline
  - stage: libncurses
  - stage: bsd-compat-headers
steps:
  - sources:
      - url: https://github.com/FRRouting/frr/archive/refs/tags/frr-{{ .FRR_VERSION }}.tar.gz
        destination: frr.tar.gz
        sha256: {{ .FRR_SHA256 }}
        sha512: {{ .FRR_SHA512 }}
    prepare:
      - |
        tar -xzf frr.tar.gz --strip-components=1
        autoreconf -fvi
        export PKG_CONFIG_PATH=/usr/lib/pkgconfig
        export LDFLAGS="-L/usr/lib -static-libgcc"
        export CPPFLAGS="-I/usr/include"
        ./configure \
          --disable-ospfd \
          --disable-ospf6d \
          --disable-ripd \
          --disable-ripngd \
          --disable-isisd \
          --disable-pimd \
          --disable-ldpd \
          --disable-nhrpd \
          --disable-eigrpd \
          --disable-babeld \
          --disable-sharpd \
          --disable-staticd \
          --disable-pbrd \
          --disable-fabricd \
          --disable-vrrpd \
          --disable-pathd \
          --disable-mgmtd \
          --disable-protobuf \
          --enable-shared \
          --enable-static \
          --enable-static-bin
    build:
      - |
        make -j 1
    install:
      - |
        make DESTDIR=/rootfs install
        cp /pkg/frr.yaml /rootfs/usr/local/etc/containers/
    test:
      - |
        mkdir -p /extensions-validator-rootfs
        cp -r /rootfs/ /extensions-validator-rootfs/rootfs
        cp /pkg/manifest.yaml /extensions-validator-rootfs/manifest.yaml
        /extensions-validator validate --rootfs=/extensions-validator-rootfs --pkg-name="${PKG_NAME}"
finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
